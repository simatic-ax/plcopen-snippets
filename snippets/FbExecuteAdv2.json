{
    "Insert PLCopen BlocksTemplates": {
    "scope": "javascript,typescript,st",
    "prefix": ["fb, plcopen, execute, 3_adv"],
    "body": [
                
        "FUNCTION_BLOCK ${1:YourFbExecuteAdv2}",
        "\t// TODO please personalize block(name)",

        "\t",
        "\tVAR_INPUT",
        "\t\texecute : BOOL;   //  Rising edge starts action once",      
        "\tEND_VAR",

        "\t",
        "\tVAR_OUTPUT",
        "\t\tdone : BOOL;   //  TRUE: Commanded functionality has been completed successfully",
        "\t\tbusy : BOOL;   //  TRUE: FB is not finished and new output values can be expected",
        "\t\tcommandAborted : BOOL;   //  TRUE: Commanded functionality has been aborted by another command  (optional)",
        "\t\terror : BOOL;   //  TRUE: An error occurred during the execution of the FB",
        "\t\tstatus : WORD := STATUS_NO_CALL;   //  WORD#16#0000 - WORD#16#7FFF: Status of the FB, WORD#16#8000 - WORD#16#FFFF: Error identification",
        "\t\tdiagnostics : Diagnostics;   //  Diagnostics information of FB (optional)",
        "\tEND_VAR",

        "\t",
        "\tVAR",
        "\t\t_executeOld : BOOL;   //  Old value of 'execute' input for edge detection",
        "\t\t_done : BOOL;   //  Static value for output 'done'",
        "\t\t_busy : BOOL;   //  Static value for output 'busy'",
        "\t\t_commandAborted : BOOL;   //  Static value for output 'commandAborted'",
        "\t\t_error : BOOL;   //  Static value for output 'error'",
        "\t\t_status : WORD := STATUS_NO_CALL;   //  Static value for output 'status'",
        "\t\t_subfunctionStatus : WORD;   //  Status or return value of called FBs, FCs and system blocks",
        "\t\t_fbErrorState : DINT;   //  State in the state machine of the block where the error occurred",
        "\t\t_fbState : FbStates;   //  State in the state machine of the FB",
        "\t\t_emptyDiagnostics : Diagnostics;   //  Empty diagnostics information (for initialization purposes only)",
        "\tEND_VAR",

        "\t",
        "\tVAR_TEMP",
        "\t\ttempExecute : BOOL;   //  Temporary value for input 'execute'",        
        "\tEND_VAR",

        "\t",
        "\tVAR CONSTANT",
        "\t\tSTATUS_EXECUTION_FINISHED : WORD := WORD#16#0000;   //  Execution finished without errors",
        "\t\tSTATUS_NO_CALL : WORD := WORD#16#7000;   //  No job being currently processed",
        "\t\tSTATUS_FIRST_CALL : WORD := WORD#16#7001;   //  First call after incoming new job (rising edge 'execute')",
        "\t\tSTATUS_SUBSEQUENT_CALL : WORD := WORD#16#7002;   //  Subsequent call during active processing without further details",
        "\t\tSTATUS_COMMAND_ABORTED : WORD := WORD#16#7FFF;   //  Commanded functionality has been aborted by another command",
        "\t\tSUB_STATUS_NO_ERROR : WORD := WORD#16#0000;   //  NO error occured in subfunction call",
        "\t\tERR_UNDEFINED_STATE : WORD := WORD#16#8600;   //  Error: due to an undefined state in state machine",
        "\t\tERR_IN_BLOCK_OPERATION : WORD := WORD#16#8001;   //  Error: Wrong operation of the function block",
        "\t\tERR_PARAMETRIZATION : WORD := WORD#16#8200;   //  Error: during parameterization",
        "\t\tERR_PROCESSING_EXTERN : WORD := WORD#16#8400;   //  Error: when processing from outside #(e. g. wrong I/O signals, axis not referenced)",
        "\t\tERR_PROCESSING_INTERN : WORD := WORD#16#8600;   //  Error: when processing internally (e. g. when calling a system function)",
        "\t\tERR_AREA_RESERVED : WORD := WORD#16#8800;   //  Error: Reserved area",
        "\t\tERR_USER_DEFINED_CLASSES : WORD := WORD#16#9000;   //  Error: User-defined error classes      ",
        "\tEND_VAR",

        "${C:",
	    "\t//===============================================================================",
	    "\t// (company) / (c)Copyright (year)",
	    "\t//-------------------------------------------------------------------------------",
	    "\t// Title:            (Title of this Block / Execute Template)",
	    "\t// Comment/Function: (that is implemented in the block)",
	    "\t//                   (Template for an FB with Execute / Busy / Done handling based on PLCopen standard 'Function Blocks for Motion Control' V2.0)",
	    "\t// Library/Family:   (that the source is dedicated to)",
	    "\t// Author:           (department / person in charge / contact)",
	    "\t// Tested with:      (test system with version)",
	    "\t// Engineering:      SIMATIC AX (SDK version)",
	    "\t// Restrictions:     (OB types, etc.)",
	    "\t// Requirements:     (hardware, technological package, memory needed, etc.)",
	    "\t//-------------------------------------------------------------------------------",
	    "\t// Change log table:",
	    "\t// Version  | Date       | Expert in charge       | Changes applied",
	    "\t//----------|------------|------------------------|------------------------------",
	    "\t// 01.00.00 | yyyy-mm-dd | (name of expert)       | First released version",
	    "\t//===============================================================================","}",

        "${C:",
        "    tempExecute := execute; // Work with temporary value / create process image",
        "     ",
        "    IF (tempExecute = TRUE) AND (_executeOld = FALSE) // Check if FB is triggered",
        "      // TODO(optional): delete next line and comment line if FB shall finish current job before new job can be started with rising edge of execute",
        "      AND (_status = STATUS_NO_CALL)",
        "    THEN // First call; initialize FB",
        "      _done := FALSE;",
        "      _busy := TRUE;",
        "      _commandAborted := FALSE;",
        "      _error := FALSE;",
        "      _status := STATUS_FIRST_CALL;",
        "      _subfunctionStatus := SUB_STATUS_NO_ERROR;",
        "      _fbErrorState := 0;",
        "      diagnostics := _emptyDiagnostics;",
        "      // State machine - start processing",
        "      _fbState := FbStates#PROCESSING_1;",
        "      ",
        "      // TODO: Initialize functionality: reset of variables, diagnostics, etc.",
        "      ",
        "      // TODO: Initialize functionality: call subordinated FBs with FALSE",
        "      //      instFB(execute := FALSE);",
        "      ",
        "    ELSIF (_status = STATUS_FIRST_CALL) THEN",
        "      _status := STATUS_SUBSEQUENT_CALL;",
        "    END_IF;",
        "    ",
        "    // Edge detection 'execute' input",
        "    _executeOld := tempExecute;",
        "     ",
        "    IF (_status = STATUS_NO_CALL) THEN // Nothing to do -> End here to reduce system load",
        "      RETURN;",
        "    END_IF;",
        "     ",
        "    CASE _fbState OF // State machine of FB",
        "      FbStates#NO_PROCESSING:",
        "          // No processing active (Note: this state must always be present and left empty)",
        "          ;",
        "        ",
        "      FbStates#PROCESSING_1: // Processing active",
        "          // TODO: Use this state for application specific code",
        "          // Call subordinated FB or functionality",
        "          //          instFB(execute := TRUE);",
        "          //          IF (instFB.done = TRUE) THEN // Subsidiary FB finished successfully",
        "          //            _status := STATUS_EXECUTION_FINISHED; // Or continue processing with next state e.g. _fbState := FbStates#PROCESSING_2;",
        "          //",
        "          //          ELSIF (instFB.error = TRUE) THEN // Error occurred in subordinated FB",
        "          //            // If the error occurred needs separate handling (e.g. close connection)",
        "          //            // please set the error output only when this error handling completed successfully",
        "          //            _status := ERR_XYZ; // Set correct status that identifies error clearly",
        "          //            _subfunctionStatus := instFB.status // Status or return value of called FBs, FCs and system blocks",
        "          //            _fbErrorState := _fbState; // Set error state number for diagnostic ",
        "          //            // TODO: Error handling",
        "          //",
        "          //          ELSIF (instFB.commandAborted = TRUE) THEN // Commanded functionality has been aborted by another command",
        "          //            // Set",
        "          //            _status := STATUS_COMMAND_ABORTED;",
        "          //            // if that must be reported external",
        "          //            // _subfunctionStatus := instFB.status // Status or return value of called FBs, FCs and system blocks",
        "          //            // _fbErrorState := _fbState; // Set error state number for diagnostic ",
        "          //            // TODO: Error handling",
        "          //          END_IF;",
        "          ;",
        "        ",
        "      FbStates#PROCESSING_2: // Further processing state",
        "          // TODO: Use this state for further application specific code",
        "          ;",
        "        ",
        "      ELSE // Undefined state in state machine reached",
        "          _status := ERR_UNDEFINED_STATE;",
        "    END_CASE;",
        "     ",
        "    // Write outputs",
        "    IF (_status = STATUS_EXECUTION_FINISHED) AND (_done = FALSE) THEN // Execution finished without errors",
        "        _done := TRUE;",
        "        _busy := FALSE;",
        "        _commandAborted := FALSE;",
        "        _error := FALSE;",
        "        // execution aborted --> set state no processing",
        "        _fbState := FbStates#NO_PROCESSING;",
        "      ",
        "    ELSIF (_status.%X15 = TRUE) AND (_error = FALSE) THEN // Error occurred (_status is WORD#16#8000 to WORD#16#FFFF)",
        "        _done := FALSE;",
        "        _busy := FALSE;",
        "        _commandAborted := FALSE;",
        "        _error := TRUE;",
        "        // Write diagnostics",
        "        diagnostics.Status := _status;",
        "        diagnostics.SubfunctionStatus := _subfunctionStatus;",
        "        diagnostics.StateNumber := _fbErrorState;",
        "        // execution aborted --> set state no processing",
        "        _fbState := FbStates#NO_PROCESSING;",
        "      ",
        "    ELSIF (_status = STATUS_COMMAND_ABORTED) AND (_commandAborted = FALSE) THEN // Commanded functionality has been aborted by another command",
        "        _done := FALSE;",
        "        _busy := FALSE;",
        "        _commandAborted := TRUE;",
        "        _error := FALSE;",
        "        // Write diagnostics",
        "        diagnostics.Status := _status;",
        "        diagnostics.SubfunctionStatus := _subfunctionStatus;",
        "        diagnostics.StateNumber := _fbErrorState;",
        "        // execution aborted --> set state no processing",
        "        _fbState := FbStates#NO_PROCESSING;",
        "      ",
        "    ELSIF (tempExecute = FALSE) AND ((_done = TRUE) OR (_error = TRUE) OR (_commandAborted = TRUE)) THEN // Reset outputs",
        "        _done := FALSE;",
        "        _busy := FALSE;",
        "        _commandAborted := FALSE;",
        "        _error := FALSE;",
        "        _status := STATUS_NO_CALL;",
        "        // TODO: Reset application specific outputs",
        "    END_IF;",
        "    ",
        "    done := _done;",
        "    busy := _busy;",
        "    commandAborted := _commandAborted;",
        "    error := _error;",
        "    status := _status;",
        "    // TODO: Write application specific static values to outputs",
        "}",

        "END_FUNCTION_BLOCK"         
    ],
    "description": "[PLCOPEN-SNIPPETS] FB with execute (Advanced V2)"
    }
}